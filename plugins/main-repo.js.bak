const fs = require('fs');
const path = require('path');
const fetch = (...args) => import('node-fetch').then(({ default: fetch }) => fetch(...args));
const { cmd } = require('../command');

cmd({
    pattern: "repo",
    alias: ["sc", "script", "info"],
    desc: "Fetch information about a GitHub repository.",
    react: "ğŸ“‚",
    category: "info",
    filename: __filename,
}, async (conn, mek, m, { from, reply }) => {

    const githubRepoURL = 'https://github.com/rehmanabdul78600786-ctrl/BOSS-BOTZ';

    try {
        // Extract username and repository name
        const match = githubRepoURL.match(/github\.com\/([^/]+)\/([^/]+)/);

        if (!match) return reply("âš ï¸ Invalid GitHub URL format.");

        const [, username, repoName] = match;

        // Fetch GitHub API data
        const response = await fetch(`https://api.github.com/repos/${username}/${repoName}`);

        if (!response.ok) {
            return reply(`âš ï¸ GitHub API error: ${response.status}`);
        }

        const repoData = await response.json();

        // Format the message
        const formattedInfo = `
*BOT NAME:*  
> ${repoData.name}

*OWNER NAME:*  
> ${repoData.owner.login}

*STARS:*  
> ${repoData.stargazers_count}

*FORKS:*  
> ${repoData.forks_count}

*GITHUB LINK:*  
> ${repoData.html_url}

*DESCRIPTION:*  
> ${repoData.description || 'No description'}

*Don't Forget To Star and Fork Repository*  

> *ğ¸ğ‘…ğ¹ğ’œğ’© ğ’œğ»ğ‘€ğ’œğ’ŸğŸ–¤*
        `;

        const ctx = {
            mentionedJid: [m.sender],
            forwardingScore: 999,
            isForwarded: true,
            forwardedNewsletterMessageInfo: {
                newsletterJid: '120363405061777123@newsletter',
                newsletterName: 'â˜”ï¾Ÿá›”ÏŒğƒğƒâ˜”â â˜†ï¾Ÿâ .â *â ï½¥â ï½¡ï¾Ÿ',
                serverMessageId: 143
            }
        };

        // Send Image + caption
        await conn.sendMessage(
            from,
            {
                image: { url: "https://files.catbox.moe/yj7zp0.png" },
                caption: formattedInfo,
                contextInfo: ctx
            },
            { quoted: mek }
        );

        // Audio file path
        const audioPath = path.join(__dirname, '../assets/menu.m4a');

        // Send audio
        await conn.sendMessage(
            from,
            {
                audio: fs.readFileSync(audioPath),
                mimetype: 'audio/mp4',
                ptt: true,
                contextInfo: ctx
            },
            { quoted: mek }
        );

    } catch (error) {
        console.error("Error in repo command:", error);
        reply("âŒ Something went wrong while fetching repository info.");
    }
});
